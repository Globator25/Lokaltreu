name: agents-ci

on:
  pull_request:
    paths:
      - 'AGENTS.md'
      - '.github/workflows/**'
      - 'apps/**/agents/**'

jobs:
  policy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Enforce CODEOWNERS approvals
        uses: mheap/github-action-required-reviewers@v2
        with:
          reviewers: 'org/sec-leads,org/platops'
      - name: Block direct changes to secrets
        shell: bash
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }})
          echo "$CHANGED" | grep -E '\.sops\.ya?ml|(^|/)\.env(\.|$)' && { echo "Secret files changed"; exit 1; } || true
