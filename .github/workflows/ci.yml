name: IaC Validate

on:
  push:
    paths: ['infra/terraform/**']
  pull_request:
    paths: ['infra/terraform/**']

jobs:
  iac-validate:
    runs-on: ubuntu-24.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      AWS_REGION: auto
      TF_IN_AUTOMATION: ${{ vars.TF_IN_AUTOMATION }}
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    strategy:
      matrix:
        env: [dev, stage, prod]

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.x'

      - name: Install age
        run: |
          sudo apt-get update
          sudo apt-get install -y age

      - name: Install sops (linux amd64)
        run: |
          SOPS_VERSION="v3.8.1"
          curl -sSL -o sops "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64"
          sudo install -m 0755 sops /usr/local/bin/sops
          sops --version

      - name: Decrypt tfvars (${{ matrix.env }})
        run: |
          set -euo pipefail
          test -n "${SOPS_AGE_KEY:-}"
          sops --decrypt "infra/terraform/envs/${{ matrix.env }}/${{ matrix.env }}.secrets.enc.tfvars" \
            > "/tmp/${{ matrix.env }}.secrets.tfvars"

      - name: Sync Terraform modules into environment
        run: |
          set -euo pipefail
          env_dir="infra/terraform/envs/${{ matrix.env }}"
          rm -rf "${env_dir}/modules"
          mkdir -p "${env_dir}/modules"
          cp -R infra/terraform/modules/. "${env_dir}/modules/"

      - name: Terraform Validate + Plan (${{ matrix.env }})
        working-directory: infra/terraform/envs/${{ matrix.env }}
        run: |
          set -euo pipefail
          terraform init -backend-config=backend.hcl
          terraform fmt -check
          terraform validate
          args=(-no-color -input=false -var-file=/tmp/${{ matrix.env }}.secrets.tfvars)
          if [ -f terraform.tfvars ]; then
            args+=(-var-file=terraform.tfvars)
          fi
          terraform plan "${args[@]}"

      - name: Cleanup decrypted secrets (${{ matrix.env }})
        if: always()
        run: rm -f "/tmp/${{ matrix.env }}.secrets.tfvars"
