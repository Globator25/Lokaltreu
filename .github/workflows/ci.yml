name: IaC Validate

on:
  push:
    paths: ['infra/terraform/**']
  pull_request:
    paths: ['infra/terraform/**']

jobs:
  iac-validate:
    runs-on: ubuntu-latest
    # R2-Creds aus Repo-Secrets; TF_IN_AUTOMATION aus Repo-Variables (oder leer ok)
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      AWS_REGION: auto
      TF_IN_AUTOMATION: ${{ vars.TF_IN_AUTOMATION }}
    strategy:
      matrix:
        env: [dev, stage, prod]

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.x'

      - name: Install sops + age
        shell: pwsh
        run: |
          sudo apt-get update
          sudo apt-get install -y age sops

      - name: Write age key
        shell: pwsh
        run: |
          New-Item -Path infra/terraform/.keys -ItemType Directory -Force | Out-Null
          Set-Content infra/terraform/.keys/age.key "${{ secrets.AGE_PRIVATE_KEY }}"

      - name: Terraform Validate + Plan (${{ matrix.env }})
        working-directory: infra/terraform
        shell: pwsh
        run: |
          # Public Key ableiten
          $pub = (age-keygen -y .\.keys\age.key) -replace '^public key:\s*',''

          # .sops.yaml robust ohne Here-String schreiben
          @(
            'creation_rules:'
            '  - path_regex: secrets/.*\.tfvars$'
            "    age: `"$pub`""
          ) | Set-Content .\.sops.yaml

          # Backend je Environment
          $backendConfig = (Resolve-Path ".\backend.${{ matrix.env }}.hcl").Path
          terraform init -reconfigure -backend-config="$backendConfig"

          # Secrets entschlüsseln
          $tmp        = Join-Path $env:TEMP "${{ matrix.env }}.secrets.tfvars"
          $secretFile = (Resolve-Path ".\secrets\${{ matrix.env }}.secrets.enc.tfvars").Path
          sops -d $secretFile | Set-Content -Path $tmp

          # Checks + Plan
          terraform fmt -check
          terraform validate
          $varsFile = (Resolve-Path ".\env\${{ matrix.env }}.tfvars").Path
          terraform plan -no-color -input=false -var-file="$varsFile" -var-file="$tmp"

          # Aufräumen
          Remove-Item $tmp -ErrorAction SilentlyContinue
          Remove-Item .\.sops.yaml -ErrorAction SilentlyContinue
