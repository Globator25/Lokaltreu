name: IaC Validate

on:
  push:
    paths: ['infra/terraform/**']
  pull_request:
    paths: ['infra/terraform/**']

jobs:
  iac-validate:
    runs-on: ubuntu-24.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      AWS_REGION: auto
      TF_IN_AUTOMATION: ${{ vars.TF_IN_AUTOMATION }}
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    strategy:
      matrix:
        env: [dev, stage, prod]

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.x'

      - name: Install age + sops
        run: |
          sudo apt-get update -y
          sudo apt-get install -y age
          curl -sSL https://github.com/getsops/sops/releases/download/v3.10.2/sops_3.10.2_amd64.deb -o sops.deb
          sudo dpkg -i sops.deb
          sops --version
          age --version

      - name: Check SOPS key presence
        run: |
          set -euo pipefail
          test -n "${SOPS_AGE_KEY:-}"
          echo "${SOPS_AGE_KEY}" | head -c 16 | grep -q '^AGE-SECRET-KEY-'

      - name: Decrypt tfvars (${{ matrix.env }})
        working-directory: infra/terraform/envs/${{ matrix.env }}
        run: |
          set -euo pipefail
          test -n "${SOPS_AGE_KEY:-}"
          shopt -s nullglob
          found=false
          for f in *.enc.tfvars; do
            found=true
            out="${f%.enc.tfvars}.tfvars"
            sops -d "$f" > "$out"
          done
          if [ "$found" != "true" ]; then
            echo "No encrypted tfvars found" >&2
            exit 1
          fi
          ls -l *.tfvars

      - name: Sync Terraform modules into environment
        run: |
          set -euo pipefail
          env_dir="infra/terraform/envs/${{ matrix.env }}"
          rm -rf "${env_dir}/modules"
          mkdir -p "${env_dir}/modules"
          cp -R infra/terraform/modules/. "${env_dir}/modules/"

      - name: Terraform Validate + Plan (${{ matrix.env }})
        working-directory: infra/terraform/envs/${{ matrix.env }}
        run: |
          set -euo pipefail
          terraform init -backend-config=backend.hcl
          terraform fmt -check
          terraform validate
          args=(-no-color -input=false)
          if [ -f terraform.tfvars ]; then
            args+=(-var-file=terraform.tfvars)
          fi
          shopt -s nullglob
          for vf in *.tfvars; do
            case "$vf" in
              terraform.tfvars) continue ;;
              *.enc.tfvars) continue ;;
            esac
            args+=(-var-file="$vf")
          done
          terraform plan "${args[@]}"

      - name: Cleanup decrypted secrets (${{ matrix.env }})
        if: always()
        working-directory: infra/terraform/envs/${{ matrix.env }}
        run: rm -f *.secrets.tfvars
