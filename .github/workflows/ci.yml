name: IaC Validate

on:
  push:
    paths: ['infra/terraform/**']
  pull_request:
    paths: ['infra/terraform/**']

jobs:
  iac-validate:
    runs-on: ubuntu-latest
    environment: dev
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      AWS_REGION: auto
      TF_IN_AUTOMATION: ${{ vars.TF_IN_AUTOMATION }} # nur EINMAL setzen

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.x'

      - name: Install sops + age
        shell: pwsh
        run: |
          sudo apt-get update
          sudo apt-get install -y age sops

      - name: Decrypt age key
        shell: pwsh
        run: |
          New-Item -Path infra/terraform/.keys -ItemType Directory -Force | Out-Null
          Set-Content infra/terraform/.keys/age.key "${{ secrets.AGE_PRIVATE_KEY }}"

      - name: Terraform Validate + Plan (dev)
        working-directory: infra/terraform
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # SOPS: Public Key ableiten und Konfig schreiben
          $pub = (Select-String -Path .\.keys\age.key -Pattern 'public key:\s*(.+)').Matches[0].Groups[1].Value
          @"
          creation_rules:
            - path_regex: secrets/.*\.tfvars$
              age: ["$pub"]
          "@ | Set-Content .\.sops.yaml

          # SOPS-Umgebung für den Lauf
          $env:SOPS_AGE_KEY_FILE = (Resolve-Path .\.keys\age.key).Path
          $env:SOPS_CONFIG       = (Resolve-Path .\.sops.yaml).Path

          # Backend initialisieren (dev)
          $backendConfig = (Resolve-Path .\backend.dev.hcl).Path
          terraform init -backend-config="$backendConfig"

          # Secrets temporär entschlüsseln
          $tmp        = Join-Path $env:TEMP 'dev.secrets.tfvars'
          $secretFile = (Resolve-Path .\secrets\dev.secrets.enc.tfvars).Path
          sops -d $secretFile | Set-Content -Path $tmp

          # Validate + Plan
          terraform fmt -check
          terraform validate
          $devVars = (Resolve-Path .\env\dev.tfvars).Path
          terraform plan -no-color -input=false -var-file="$devVars" -var-file="$tmp"

          # Cleanup
          Remove-Item $tmp -ErrorAction SilentlyContinue
