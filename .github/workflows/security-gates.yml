name: security-gates
on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }

      - name: Install
        run: npm ci --include=dev

      - name: Start API (test profile)
        run: npm run -w apps/api start:test &
      - name: Wait for API
        run: npx wait-on http://localhost:3001/health

      - name: Anti-Replay
        run: npm run -w apps/api test:security:replay

      - name: Device-Proof
        run: npm run -w apps/api test:security:device-proof

      - name: Plan-Gate
        run: npm run -w apps/api test:security:plan-gate
