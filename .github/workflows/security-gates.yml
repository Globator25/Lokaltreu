name: security-gates

on:
  pull_request:
  push:
    branches: [main]

env:
  NODE_VERSION: 20
  VITEST_COVERAGE: 'false'

jobs:
  anti-replay:
    name: anti-replay
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run targeted security suites
        env:
          VITEST_COVERAGE: 'false'
        run: |
          npx vitest run --pool=threads \
            tests/parallel/anti-replay.spec.ts \
            apps/api/tests/mw/idempotency*.spec.ts \
            apps/api/src/middleware/errors/*.spec.ts
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - working-directory: apps/api
        run: npm ci
      - working-directory: apps/api
        run: npm test -- --pool=threads tests/parallel/anti-replay.spec.ts

  device-proof:
    name: device-proof
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - working-directory: apps/api
        run: npm ci
      - working-directory: apps/api
        run: npm test -- --pool=threads src/security/device/verifyDeviceProof.spec.ts

  problem-json:
    name: rfc7807-and-plan-gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - working-directory: apps/api
        run: npm ci
      - working-directory: apps/api
        run: npm test -- --pool=threads tests/plan/plan-gate.spec.ts

  terraform:
    name: terraform-validate-eu-only
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/terraform
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform fmt -check
      - run: terraform validate
      - name: Ensure only EU regions are referenced
        run: |
          ! grep -R -n -E "region\\s*=\\s*\"(us|ap|sa|af|me)" . || (echo "non-EU cloud region detected" && exit 1)

  secrets:
    name: secrets-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
