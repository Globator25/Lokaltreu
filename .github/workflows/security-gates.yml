name: security-gates
on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}
jobs:
  security:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      API_BASE: ${{ secrets.API_BASE || 'http://localhost:4010' }}
      AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
      STARTER_TOKEN: ${{ secrets.STARTER_TOKEN }}
      DP_PRIV: ${{ secrets.DP_PRIV }}
      DP_PUB: ${{ secrets.DP_PUB }}
      NPM_CONFIG_ENGINE_STRICT: 'false'
      HUSKY: '0'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: npm
          cache-dependency-path: |
            package-lock.json
            apps/**/package-lock.json
            .github/workflows/cache-version-3

      - name: Node diagnostics
        run: node -v && npm -v && npm config get engine-strict || true

      - name: Relax engine strict (CI only)
        run: echo "engine-strict=false" >> .npmrc
      - name: Install all workspaces + root
        run: npm ci --workspaces --include-workspace-root --prefer-offline --no-audit --no-fund
      - name: Start API (test profile)
        run: |
          nohup npm run security:api:start > security-api.log 2>&1 &
          echo $! > api.pid
      - name: Wait for API
        run: |
          for i in {1..90}; do
            if curl -fsS "${API_BASE}/health" >/dev/null 2>&1; then exit 0; fi
            sleep 1
          done
          echo "API not healthy in time"; cat security-api.log || true; exit 1
      - name: Anti-Replay
        run: npm run test:security:anti-replay
      - name: Device-Proof
        run: npm run test:security:device-proof
      - name: Debug keys header only
        if: ${{ always() }}
        run: |
          echo "${DP_PRIV}" | head -n1
          echo "${DP_PUB}"  | head -n1
      - name: Plan-Gate
        run: npm run test:security:plan-gate
      - name: Dump API log on failure
        if: failure()
        run: |
          echo "--- security-api.log ---"
          [[ -f security-api.log ]] && tail -n +1 security-api.log || true
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-gates-logs
          path: |
            security-api.log
            *.json
            scripts/security/*.mjs


