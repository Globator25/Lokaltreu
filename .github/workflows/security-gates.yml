name: security-gates
on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Wichtig: Workspaces explizit installieren (inkl. workspace-root)
      - name: Install (workspaces)
        env:
          NPM_CONFIG_WORKSPACES: "true"
        run: npm ci --workspaces --include-workspace-root

      # Schlanker Diagnose-Step: zeigt sofort, ob @lokaltreu/types im Runner auflÃ¶sbar ist
      - name: Diagnose workspace types
        run: |
          node -v
          npm -v
          echo "Resolve package.json:"
          node -p "require.resolve('@lokaltreu/types/package.json')"
          echo "List scope dir:"
          ls -la node_modules/@lokaltreu || true

      - name: Build API
        run: npm run -w apps/api build

      - name: Start API (test profile)
        run: |
          npm run -w apps/api start:test &
          echo "API_PID=$!" >> $GITHUB_ENV

      - name: Wait for API
        run: npx wait-on http://localhost:3001/health

      - name: Plan-Gate
        run: npm run -w apps/api test:plan

      - name: Stop API
        if: always()
        run: |
          if [ -n "${API_PID:-}" ]; then
            kill "$API_PID" || true
          fi
