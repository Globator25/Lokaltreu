name: security-gates
on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install (workspaces)
        run: npm ci --workspaces --include-workspace-root

      - name: Build workspace types
        run: npm run -w packages/types build

      - name: Build API
        run: npm run -w apps/api build

      - name: Start API (test profile)
        shell: bash
        run: |
          set -euo pipefail
          npm run -w apps/api start:test &
          echo $! > /tmp/api.pid
          sleep 1
          ps -p "$(cat /tmp/api.pid)" || true

      - name: Wait for API (hard timeout)
        shell: bash
        run: |
          set -euo pipefail
          # maximal 90s warten (sonst h√§ngt der Job bis zum GH Timeout)
          npx --yes wait-on@9.0.3 --timeout 90000 --interval 250 http://127.0.0.1:3001/health

      - name: Plan-Gate
        run: npm run -w apps/api test:plan

      - name: Stop API
        if: always()
        shell: bash
        run: |
          if [ -f /tmp/api.pid ]; then
            kill "$(cat /tmp/api.pid)" || true
          fi
