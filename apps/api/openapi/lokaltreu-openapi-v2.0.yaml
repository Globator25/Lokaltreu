openapi: 3.1.0

info:
  title: Lokaltreu HTTP-API
  version: "2.0"
  description: >
    Digitale Stempelkarte als HTTP-API. RFC 7807 für Fehler. Idempotenz via Header.
    Referral-Funktionen sind planabhängig (Starter blockiert).
  termsOfService: https://lokaltreu.example/terms
  contact:
    name: Lokaltreu API Support
    url: https://lokaltreu.example/support
    email: support@lokaltreu.example
  license:
    name: Proprietary
  x-schema-drift-policy: "0"

servers:
  - url: https://api.lokaltreu.example/v2
    description: Production API v2 (current)
  - url: https://api.lokaltreu.example/v1
    description: Production API v1 (legacy)
  - url: http://localhost:3000
    description: Local dev API (port 3000)

tags:
  - name: Admins
    description: Admin authentication and session management.
  - name: Devices
    description: Device registration and authorization flows.
  - name: Stamps
    description: Device registration and authorization flows.
  - name: Rewards
    description: Reward redemption operations.
  - name: Referrals
    description: Referral link retrieval and validation.
  - name: JWKS
    description: Public keys for token verification.
  - name: DSR
    description: Data subject requests (DSR) and tombstone workflow.
  - name: Reporting
    description: Aggregated KPIs and time series for admin dashboards.

security: []

components:
  securitySchemes:
    AdminAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    DeviceKey:
      type: apiKey
      in: header
      name: X-Device-Key

  headers:
    Idempotency-Key:
      description: >
        Echo des Idempotenz-Schlüssels. Gültigkeit 24 h. Scope {tenantId,route,bodyHash}.
      required: false
      schema:
        type: string
        minLength: 8
        maxLength: 128
    Retry-After:
      description: Seconds until the client may retry.
      required: false
      schema:
        type: integer
        minimum: 1

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      description: Idempotenz für Schreibaktionen. 24 h gültig.
      schema:
        type: string
        minLength: 8
        maxLength: 128
    XTenantId:
      name: X-Tenant-Id
      in: header
      required: true
      description: Tenant context for anonymous customer flows (pseudonymous, no PII).
      schema:
        type: string
        format: uuid
    XCardId:
      name: X-Card-Id
      in: header
      required: false
      description: Pseudonymous customer card id (no PII).
      schema:
        type: string
        minLength: 1
        maxLength: 128
    XCardIdRequired:
      name: X-Card-Id
      in: header
      required: true
      description: Pseudonymous customer card id (no PII).
      schema:
        type: string
        minLength: 1
        maxLength: 128
    XDeviceProof:
      in: header
      name: X-Device-Proof
      required: true
      schema:
        type: string

    XDeviceTimestamp:
      in: header
      name: X-Device-Timestamp
      required: true
      description: Unix timestamp in seconds (allowed skew ±30s).
      schema:
        type: string
        pattern: "^[0-9]{9,}$"
    DsrRequestId:
      name: dsr_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    Problem:
      type: object
      additionalProperties: true
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
        error_code:
          type: string
          enum:
            - TOKEN_EXPIRED
            - TOKEN_REUSE
            - SELF_REFERRAL_BLOCKED
            - REFERRAL_LIMIT_REACHED
            - REFERRAL_TENANT_MISMATCH
            - REFERRAL_CODE_INVALID
            - PLAN_NOT_ALLOWED
            - RATE_LIMITED
            - IDEMPOTENCY_KEY_REQUIRED
            - IDEMPOTENCY_KEY_INVALID
        correlation_id:
          type: string
        retry_after:
          type: integer
          minimum: 1

    AdminLoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 12

    AdminRefreshRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    AdminSessionResponse:
      type: object
      required:
        - accessToken
        - refreshToken
        - expiresIn
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
          minimum: 1

    AdminRegistrationResponse:
      type: object
      additionalProperties: false
      required:
        - adminId
        - tenantId
        - accessToken
        - refreshToken
        - expiresIn
      properties:
        adminId:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
          minimum: 1

    JwksResponse:
      type: object
      required:
        - keys
      properties:
        keys:
          type: array
          items:
            type: object
    DsrSubject:
      type: object
      additionalProperties: false
      required:
        - subject_type
        - subject_id
      properties:
        subject_type:
          type: string
          enum:
            - card_id
            - device_id
            - subject_id
        subject_id:
          type: string
          minLength: 1
          maxLength: 128
    DsrRequestCreateRequest:
      type: object
      additionalProperties: false
      required:
        - requestType
        - subject
      properties:
        requestType:
          type: string
          enum:
            - DELETE
            - ERASURE
        subject:
          $ref: "#/components/schemas/DsrSubject"
        reason:
          type: string
          maxLength: 256
    DsrRequestResponse:
      type: object
      additionalProperties: false
      required:
        - dsrRequestId
        - status
        - requestType
        - subject
        - createdAt
      properties:
        dsrRequestId:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - PENDING
            - FULFILLED
            - REJECTED
        requestType:
          type: string
          enum:
            - DELETE
            - ERASURE
        subject:
          $ref: "#/components/schemas/DsrSubject"
        createdAt:
          type: string
          format: date-time
    DsrRequestStatusResponse:
      type: object
      additionalProperties: false
      required:
        - dsrRequestId
        - status
        - requestType
        - subject
        - createdAt
      properties:
        dsrRequestId:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - PENDING
            - FULFILLED
            - REJECTED
        requestType:
          type: string
          enum:
            - DELETE
            - ERASURE
        subject:
          $ref: "#/components/schemas/DsrSubject"
        createdAt:
          type: string
          format: date-time
        fulfilledAt:
          type: string
          format: date-time
          nullable: true
    DsrFulfillRequest:
      type: object
      additionalProperties: false
      properties:
        action:
          type: string
          enum:
            - DELETE
            - PSEUDONYMIZE

    StampTokenResponse:
      type: object
      required:
        - qrToken
        - jti
        - expiresAt
      properties:
        qrToken:
          type: string
        jti:
          type: string
        expiresAt:
          type: string
          format: date-time

    StampClaimRequest:
      type: object
      required:
        - qrToken
      properties:
        qrToken:
          type: string
        ref:
          type: string
          nullable: true

    CardState:
      type: object
      additionalProperties: false
      required:
        - currentStamps
        - stampsRequired
        - rewardsAvailable
      properties:
        currentStamps:
          type: integer
          minimum: 0
        stampsRequired:
          type: integer
          minimum: 1
        rewardsAvailable:
          type: integer
          minimum: 0

    OfferSnippet:
      type: object
      additionalProperties: false
      required:
        - title
      properties:
        title:
          type: string
        body:
          type: string
          nullable: true

    StampClaimResponse:
      $ref: "#/components/schemas/StampClaimResponsePayload"

    StampClaimResponsePayload:
      type: object
      additionalProperties: false
      required:
        - cardState
      properties:
        cardState:
          $ref: "#/components/schemas/CardState"
        offer:
          allOf:
            - $ref: "#/components/schemas/OfferSnippet"
          nullable: true

    RedeemResponse:
      type: object
      additionalProperties: false
      required:
        - cardState
      properties:
        cardState:
          $ref: "#/components/schemas/CardState"

    DeviceRegistrationLinkResponse:
      type: object
      additionalProperties: false
      required:
        - linkUrl
        - token
        - expiresAt
      properties:
        linkUrl:
          type: string
          format: uri
        token:
          type: string
        expiresAt:
          type: string
          format: date-time
        qrImageUrl:
          type: string
          format: uri
          nullable: true
    ReportingCounts:
      type: object
      additionalProperties: false
      required:
        - day
        - week
        - month
      properties:
        day:
          type: integer
          minimum: 0
        week:
          type: integer
          minimum: 0
        month:
          type: integer
          minimum: 0
    ReportingRates:
      type: object
      additionalProperties: false
      required:
        - day
        - week
        - month
      properties:
        day:
          type: number
          minimum: 0
          maximum: 100
        week:
          type: number
          minimum: 0
          maximum: 100
        month:
          type: number
          minimum: 0
          maximum: 100
    ReportingReferralKpis:
      type: object
      additionalProperties: false
      required:
        - linksIssued
        - qualified
        - bonusStamps
        - conversionRate
      properties:
        linksIssued:
          $ref: "#/components/schemas/ReportingCounts"
        qualified:
          $ref: "#/components/schemas/ReportingCounts"
        bonusStamps:
          $ref: "#/components/schemas/ReportingCounts"
        conversionRate:
          $ref: "#/components/schemas/ReportingRates"
    ReportingDeviceActivity:
      type: object
      additionalProperties: false
      required:
        - activeDevices
      properties:
        activeDevices:
          type: integer
          minimum: 0
    ReportingPlanUsage:
      type: object
      additionalProperties: false
      required:
        - period
        - stampsUsed
        - stampsLimit
        - usagePercent
        - warningEmitted
        - upgradeSignalEmitted
      properties:
        period:
          type: string
          pattern: "^[0-9]{4}-[0-9]{2}$"
        stampsUsed:
          type: integer
          minimum: 0
        stampsLimit:
          type: integer
          minimum: 0
          nullable: true
        usagePercent:
          type: integer
          minimum: 0
          maximum: 100
          nullable: true
        warningEmitted:
          type: boolean
        upgradeSignalEmitted:
          type: boolean
    ReportingSummaryResponse:
      type: object
      additionalProperties: false
      required:
        - stamps
        - rewards
        - referrals
        - deviceActivity
        - planUsage
        - activeCampaigns
      properties:
        stamps:
          $ref: "#/components/schemas/ReportingCounts"
        rewards:
          $ref: "#/components/schemas/ReportingCounts"
        referrals:
          $ref: "#/components/schemas/ReportingReferralKpis"
        deviceActivity:
          $ref: "#/components/schemas/ReportingDeviceActivity"
        planUsage:
          $ref: "#/components/schemas/ReportingPlanUsage"
        activeCampaigns:
          type: integer
          minimum: 0
    ReportingTimeseriesBucket:
      type: object
      additionalProperties: false
      required:
        - start
        - end
        - count
      properties:
        start:
          type: string
          format: date-time
        end:
          type: string
          format: date-time
        count:
          type: integer
          minimum: 0
    ReportingTimeseriesResponse:
      type: object
      additionalProperties: false
      required:
        - metric
        - bucket
        - from
        - to
        - series
      properties:
        metric:
          type: string
          enum:
            - stamps
            - rewards
            - referral_links
            - referral_qualified
            - referral_bonus_stamps
        bucket:
          type: string
          enum:
            - day
            - week
            - month
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        series:
          type: array
          items:
            $ref: "#/components/schemas/ReportingTimeseriesBucket"

  responses:
    400BadRequest:
      description: Ungültige Anfrage
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          examples:
            token_expired:
              summary: Token abgelaufen
              value:
                type: "https://errors.lokaltreu.example/token/expired"
                title: "Token expired"
                status: 400
                error_code: "TOKEN_EXPIRED"
                correlation_id: "abc123"
    401Unauthorized:
      description: Nicht autorisiert
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
    403Forbidden:
      description: Verboten
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
    409Conflict:
      description: Konflikt
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          examples:
            token_reuse:
              summary: Token bereits verwendet
              value:
                type: "https://errors.lokaltreu.example/token/reuse"
                title: "Token reuse"
                status: 409
                error_code: "TOKEN_REUSE"
                correlation_id: "abc123"
    422Unprocessable:
      description: Semantisch fehlerhaft
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          examples:
            referral_code_invalid:
              summary: Referral code invalid or unknown
              value:
                type: "https://errors.lokaltreu.example/referral/code-invalid"
                title: "Invalid referral code"
                status: 422
                detail: "Referral code is invalid or unknown."
                instance: "/stamps/claim"
                error_code: "REFERRAL_CODE_INVALID"
                correlation_id: "11111111-2222-3333-4444-555555555555"
    429RateLimited:
      description: Rate-Limit erreicht
      headers:
        Retry-After:
          $ref: "#/components/headers/Retry-After"
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
    500ServerError:
      description: Interner Serverfehler
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"

paths:
  /admins/register:
    post:
      summary: Registriert Admin+Mandant
      description: Creates the initial admin account and tenant.
      tags:
        - Admins
      operationId: registerAdmin
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 12
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminRegistrationResponse"
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "409":
          description: Conflict
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /admins/login:
    post:
      summary: Admin login
      description: Issues a new admin session for valid credentials.
      tags:
        - Admins
      operationId: loginAdmin
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminLoginRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminSessionResponse"
              examples:
                session:
                  summary: Admin session issued
                  value:
                    accessToken: "access.jwt.placeholder"
                    refreshToken: "refresh.jwt.placeholder"
                    expiresIn: 900
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /admins/reporting/summary:
    get:
      summary: Liefert aggregierte KPIs fuer das Admin-Dashboard
      description: Aggregated stamps/rewards/referral KPIs and plan usage.
      tags:
        - Reporting
      operationId: getReportingSummary
      security:
        - AdminAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReportingSummaryResponse"
              examples:
                summary:
                  summary: Aggregated KPIs
                  value:
                    stamps:
                      day: 3
                      week: 14
                      month: 45
                    rewards:
                      day: 1
                      week: 4
                      month: 9
                    referrals:
                      linksIssued:
                        day: 2
                        week: 7
                        month: 18
                      qualified:
                        day: 1
                        week: 3
                        month: 8
                      bonusStamps:
                        day: 0
                        week: 2
                        month: 5
                      conversionRate:
                        day: 50
                        week: 43
                        month: 44
                    deviceActivity:
                      activeDevices: 2
                    planUsage:
                      period: "2025-09"
                      stampsUsed: 45
                      stampsLimit: 120
                      usagePercent: 38
                      warningEmitted: false
                      upgradeSignalEmitted: false
                    activeCampaigns: 1
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "403":
          description: Forbidden
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "500":
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /admins/reporting/timeseries:
    get:
      summary: Liefert Zeitreihen fuer Reporting-Metriken
      description: Time series buckets for stamps, rewards, and referral metrics.
      tags:
        - Reporting
      operationId: getReportingTimeseries
      security:
        - AdminAuth: []
      parameters:
        - name: metric
          in: query
          required: true
          schema:
            type: string
            enum:
              - stamps
              - rewards
              - referral_links
              - referral_qualified
              - referral_bonus_stamps
        - name: bucket
          in: query
          required: true
          schema:
            type: string
            enum:
              - day
              - week
              - month
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReportingTimeseriesResponse"
              examples:
                stamps_daily:
                  summary: Daily stamp counts
                  value:
                    metric: "stamps"
                    bucket: "day"
                    from: "2025-09-01T00:00:00.000Z"
                    to: "2025-09-04T00:00:00.000Z"
                    series:
                      - start: "2025-09-01T00:00:00.000Z"
                        end: "2025-09-02T00:00:00.000Z"
                        count: 4
                      - start: "2025-09-02T00:00:00.000Z"
                        end: "2025-09-03T00:00:00.000Z"
                        count: 6
                      - start: "2025-09-03T00:00:00.000Z"
                        end: "2025-09-04T00:00:00.000Z"
                        count: 2
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "403":
          description: Forbidden
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "500":
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /admins/refresh:
    post:
      summary: Refresh admin session
      description: Refreshes an admin session using a refresh token.
      tags:
        - Admins
      operationId: refreshAdminSession
      security:
        - AdminAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminRefreshRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminSessionResponse"
              examples:
                refreshed:
                  summary: Admin session refreshed
                  value:
                    accessToken: "access.jwt.placeholder"
                    refreshToken: "refresh.jwt.placeholder"
                    expiresIn: 900
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                refresh_expired:
                  summary: Refresh token expired
                  value:
                    type: "https://errors.lokaltreu.example/auth/refresh-expired"
                    title: "Refresh token expired"
                    status: 401
                    error_code: "TOKEN_EXPIRED"
                    correlation_id: "5b2f0d48-4b4b-4e45-9c9b-2cf0cfb16c8a"
        "429":
          description: Rate limited
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /admins/logout:
    post:
      summary: Logout admin session
      description: Revokes the current admin session.
      tags:
        - Admins
      operationId: logoutAdmin
      security:
        - AdminAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
      responses:
        "204":
          description: No Content
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                session_invalid:
                  summary: Session invalid
                  value:
                    type: "https://errors.lokaltreu.example/auth/session-invalid"
                    title: "Session invalid"
                    status: 401
                    error_code: "TOKEN_EXPIRED"
                    correlation_id: "8d1f5e6a-3a4d-4c71-9ab0-63e5af73b2b1"
        "429":
          description: Rate limited
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /.well-known/jwks.json:
    get:
      summary: JWKS
      description: Returns the public JWKS for token verification.
      tags:
        - JWKS
      operationId: getJwks
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JwksResponse"
              examples:
                jwks:
                  summary: Public JWKS
                  value:
                    keys:
                      - kty: "OKP"
                        crv: "Ed25519"
                        kid: "admin-signing-2025-01"
                        x: "0zQmOeXb8c2u1nTQ7t9I3q5oS8l3n2tqjK2xw4iP9zA"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                jwks_blocked:
                  summary: JWKS access blocked
                  value:
                    type: "https://errors.lokaltreu.example/auth/jwks-blocked"
                    title: "JWKS access blocked"
                    status: 401
                    error_code: "TOKEN_EXPIRED"
                    correlation_id: "e6b8c2f9-9c5b-4b7f-9f3c-0a1e2b3c4d5e"

  /devices/registration-links:
    post:
      summary: Erzeugt einmaligen Registrierungslink (TTL 15 Min)
      description: Idempotent. Link ist einmalig und zeitlich begrenzt.
      tags:
        - Devices
      operationId: createDeviceRegistrationLink
      security:
        - AdminAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        "201":
          description: Link erstellt
          headers:
            Idempotency-Key:
              $ref: "#/components/headers/Idempotency-Key"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeviceRegistrationLinkResponse"
        "400":
          $ref: "#/components/responses/400BadRequest"
        "401":
          $ref: "#/components/responses/401Unauthorized"
        "403":
          $ref: "#/components/responses/403Forbidden"
        "409":
          $ref: "#/components/responses/409Conflict"
        "429":
          $ref: "#/components/responses/429RateLimited"
        "500":
          $ref: "#/components/responses/500ServerError"

  /devices/register/confirm:
    post:
      summary: Bestätigt Gerätebindung
      description: Einmalig verwendbar. Idempotent. Sicherheits-E-Mail wird versendet.
      tags:
        - Devices
      operationId: confirmDeviceRegistration
      security: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required:
                - token
              properties:
                token:
                  type: string
      responses:
        "204":
          description: Bestätigt
          headers:
            Idempotency-Key:
              $ref: "#/components/headers/Idempotency-Key"
        "400":
          $ref: "#/components/responses/400BadRequest"
        "403":
          description: PLAN_NOT_ALLOWED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                plan_not_allowed:
                  summary: Plan gate enforced
                  value:
                    type: "https://errors.lokaltreu.example/plan/not-allowed"
                    title: "Plan not allowed"
                    status: 403
                    error_code: "PLAN_NOT_ALLOWED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "409":
          $ref: "#/components/responses/409Conflict"
        "429":
          $ref: "#/components/responses/429RateLimited"
        "500":
          $ref: "#/components/responses/500ServerError"

  /dsr/requests:
    post:
      summary: Create DSR request
      description: Creates a DSR request and records a tombstone on fulfillment.
      tags:
        - DSR
      operationId: createDsrRequest
      security:
        - AdminAuth: []
      parameters:
        - $ref: "#/components/parameters/XTenantId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DsrRequestCreateRequest"
            examples:
              delete_request:
                summary: Delete request for card_id
                value:
                  requestType: "DELETE"
                  subject:
                    subject_type: "card_id"
                    subject_id: "card-123"
                  reason: "Customer requested erasure."
      responses:
        "201":
          description: Created
          headers:
            Idempotency-Key:
              $ref: "#/components/headers/Idempotency-Key"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DsrRequestResponse"
              examples:
                created:
                  summary: DSR request created
                  value:
                    dsrRequestId: "11111111-2222-3333-4444-555555555555"
                    status: "PENDING"
                    requestType: "DELETE"
                    subject:
                      subject_type: "card_id"
                      subject_id: "card-123"
                    createdAt: "2026-01-08T12:00:00Z"
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                validation_error:
                  summary: Validation failed
                  value:
                    type: "https://errors.lokaltreu.example/request/invalid"
                    title: "Bad Request"
                    status: 400
                    detail: "Invalid requestType"
                    instance: "/dsr/requests"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                unauthorized:
                  summary: Missing or invalid auth
                  value:
                    type: "https://errors.lokaltreu.example/auth/unauthorized"
                    title: "Unauthorized"
                    status: 401
                    error_code: "TOKEN_EXPIRED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "403":
          description: PLAN_NOT_ALLOWED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                plan_not_allowed:
                  summary: Plan gate enforced
                  value:
                    type: "https://errors.lokaltreu.example/plan/not-allowed"
                    title: "Plan not allowed"
                    status: 403
                    error_code: "PLAN_NOT_ALLOWED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "409":
          description: Conflict
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                conflict:
                  summary: Idempotency conflict
                  value:
                    type: "https://errors.lokaltreu.example/token/reuse"
                    title: "Conflict"
                    status: 409
                    error_code: "TOKEN_REUSE"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "429":
          description: Rate limited
          headers:
            Retry-After:
              $ref: "#/components/headers/Retry-After"
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                rate_limited:
                  summary: Rate limited
                  value:
                    type: "https://errors.lokaltreu.example/rate/limited"
                    title: "Rate limited"
                    status: 429
                    error_code: "RATE_LIMITED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "500":
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                server_error:
                  summary: Internal error
                  value:
                    type: "https://errors.lokaltreu.example/server/error"
                    title: "Internal Server Error"
                    status: 500
                    correlation_id: "11111111-2222-3333-4444-555555555555"

  /dsr/requests/{dsr_id}:
    get:
      summary: Get DSR request status
      description: Returns status and metadata for a DSR request.
      tags:
        - DSR
      operationId: getDsrRequest
      security:
        - AdminAuth: []
      parameters:
        - $ref: "#/components/parameters/DsrRequestId"
        - $ref: "#/components/parameters/XTenantId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DsrRequestStatusResponse"
              examples:
                status:
                  summary: DSR request status
                  value:
                    dsrRequestId: "11111111-2222-3333-4444-555555555555"
                    status: "PENDING"
                    requestType: "DELETE"
                    subject:
                      subject_type: "card_id"
                      subject_id: "card-123"
                    createdAt: "2026-01-08T12:00:00Z"
                    fulfilledAt: null
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                validation_error:
                  summary: Validation failed
                  value:
                    type: "https://errors.lokaltreu.example/request/invalid"
                    title: "Bad Request"
                    status: 400
                    detail: "Invalid dsr_id"
                    instance: "/dsr/requests/{dsr_id}"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                unauthorized:
                  summary: Missing or invalid auth
                  value:
                    type: "https://errors.lokaltreu.example/auth/unauthorized"
                    title: "Unauthorized"
                    status: 401
                    error_code: "TOKEN_EXPIRED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "403":
          description: PLAN_NOT_ALLOWED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                plan_not_allowed:
                  summary: Plan gate enforced
                  value:
                    type: "https://errors.lokaltreu.example/plan/not-allowed"
                    title: "Plan not allowed"
                    status: 403
                    error_code: "PLAN_NOT_ALLOWED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "409":
          description: Conflict
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                conflict:
                  summary: Request already fulfilled
                  value:
                    type: "https://errors.lokaltreu.example/token/reuse"
                    title: "Conflict"
                    status: 409
                    error_code: "TOKEN_REUSE"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "429":
          description: Rate limited
          headers:
            Retry-After:
              $ref: "#/components/headers/Retry-After"
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                rate_limited:
                  summary: Rate limited
                  value:
                    type: "https://errors.lokaltreu.example/rate/limited"
                    title: "Rate limited"
                    status: 429
                    error_code: "RATE_LIMITED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "500":
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                server_error:
                  summary: Internal error
                  value:
                    type: "https://errors.lokaltreu.example/server/error"
                    title: "Internal Server Error"
                    status: 500
                    correlation_id: "11111111-2222-3333-4444-555555555555"

  /dsr/requests/{dsr_id}/fulfill:
    post:
      summary: Fulfill DSR request
      description: Triggers deletion/pseudonymization and inserts tombstone records.
      tags:
        - DSR
      operationId: fulfillDsrRequest
      security:
        - AdminAuth: []
      parameters:
        - $ref: "#/components/parameters/DsrRequestId"
        - $ref: "#/components/parameters/XTenantId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DsrFulfillRequest"
            examples:
              fulfill_delete:
                summary: Fulfill delete
                value:
                  action: "DELETE"
      responses:
        "200":
          description: OK
          headers:
            Idempotency-Key:
              $ref: "#/components/headers/Idempotency-Key"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DsrRequestStatusResponse"
              examples:
                fulfilled:
                  summary: DSR request fulfilled
                  value:
                    dsrRequestId: "11111111-2222-3333-4444-555555555555"
                    status: "FULFILLED"
                    requestType: "DELETE"
                    subject:
                      subject_type: "card_id"
                      subject_id: "card-123"
                    createdAt: "2026-01-08T12:00:00Z"
                    fulfilledAt: "2026-01-08T12:10:00Z"
        "400":
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                validation_error:
                  summary: Validation failed
                  value:
                    type: "https://errors.lokaltreu.example/request/invalid"
                    title: "Bad Request"
                    status: 400
                    detail: "Invalid action"
                    instance: "/dsr/requests/{dsr_id}/fulfill"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                unauthorized:
                  summary: Missing or invalid auth
                  value:
                    type: "https://errors.lokaltreu.example/auth/unauthorized"
                    title: "Unauthorized"
                    status: 401
                    error_code: "TOKEN_EXPIRED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "403":
          description: PLAN_NOT_ALLOWED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                plan_not_allowed:
                  summary: Plan gate enforced
                  value:
                    type: "https://errors.lokaltreu.example/plan/not-allowed"
                    title: "Plan not allowed"
                    status: 403
                    error_code: "PLAN_NOT_ALLOWED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "409":
          description: Conflict
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                conflict:
                  summary: Already fulfilled
                  value:
                    type: "https://errors.lokaltreu.example/token/reuse"
                    title: "Conflict"
                    status: 409
                    error_code: "TOKEN_REUSE"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "429":
          description: Rate limited
          headers:
            Retry-After:
              $ref: "#/components/headers/Retry-After"
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                rate_limited:
                  summary: Rate limited
                  value:
                    type: "https://errors.lokaltreu.example/rate/limited"
                    title: "Rate limited"
                    status: 429
                    error_code: "RATE_LIMITED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "500":
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                server_error:
                  summary: Internal error
                  value:
                    type: "https://errors.lokaltreu.example/server/error"
                    title: "Internal Server Error"
                    status: 500
                    correlation_id: "11111111-2222-3333-4444-555555555555"

  /stamps/tokens:
    post:
      summary: Erzeugt einmaligen Stempel-Token (QR)
      description: Issues a one-time stamp token for client scan.
      tags:
        - Stamps
      operationId: createStampToken
      security:
        - DeviceKey: []
        - AdminAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        "201":
          description: Created
          headers:
            Idempotency-Key:
              $ref: "#/components/headers/Idempotency-Key"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StampTokenResponse"
        "429":
          description: RATE_LIMITED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /stamps/claim:
    post:
      summary: Löst Stempel ein; qualifiziert ggf. Referral und bucht Bonus
      description: Claims a stamp and applies referral rules if eligible.
      tags:
        - Stamps
      operationId: claimStamp
      security: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/XCardId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StampClaimRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StampClaimResponse"
        "400":
          description: TOKEN_EXPIRED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "409":
          description: TOKEN_REUSE | REFERRAL_TENANT_MISMATCH
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "403":
          description: PLAN_NOT_ALLOWED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                plan_not_allowed:
                  summary: Plan gate enforced
                  value:
                    type: "https://errors.lokaltreu.example/plan/not-allowed"
                    title: "Plan not allowed"
                    status: 403
                    error_code: "PLAN_NOT_ALLOWED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "422":
          $ref: "#/components/responses/422Unprocessable"
        "429":
          description: RATE_LIMITED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"

  /rewards/redeem:
    post:
      summary: Löst eine Prämie ein
      description: Redeems a reward for a valid redemption token.
      tags:
        - Rewards
      operationId: redeemReward
      security:
        - DeviceKey: []
      parameters:
        - $ref: '#/components/parameters/XDeviceProof'
        - $ref: '#/components/parameters/XDeviceTimestamp'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required:
                - redeemToken
              properties:
                redeemToken:
                  type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RedeemResponse"
        "400":
          description: TOKEN_EXPIRED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "403":
          description: PLAN_NOT_ALLOWED
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
              examples:
                plan_not_allowed:
                  summary: Plan gate enforced
                  value:
                    type: "https://errors.lokaltreu.example/plan/not-allowed"
                    title: "Plan not allowed"
                    status: 403
                    error_code: "PLAN_NOT_ALLOWED"
                    correlation_id: "11111111-2222-3333-4444-555555555555"
        "409":
          description: TOKEN_REUSE
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
        "429":
          $ref: "#/components/responses/429RateLimited"
        "500":
          $ref: "#/components/responses/500ServerError"

  /referrals/link:
    get:
      summary: Liefert personalisierten Referral-Link (Werber)
      description: Returns the referral link for an existing customer.
      tags:
        - Referrals
      operationId: getReferralLink
      security: []
      parameters:
        - $ref: '#/components/parameters/XTenantId'
        - $ref: '#/components/parameters/XCardIdRequired'
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - refCodeURL
                properties:
                  refCodeURL:
                    type: string
                    format: uri
        "401":
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/Problem"
